<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>زاد الذاكرين — تطبيق الأذكار المتكامل</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&family=Amiri&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#c5a059; --primary-dark:#8e6d2d; --accent:#3498db; --bg:#0a0b10; --card:#16181d; --text:#e0e0e0; --soft:rgba(255,255,255,0.05);
    }
    .theme-blue{ --primary:#3498db; --primary-dark:#1d6fa5; --bg:#0a1520; --card:#16202d; --text:#e0f0ff; }
    .theme-green{ --primary:#2ecc71; --primary-dark:#27ae60; --bg:#0a100b; --card:#16201a; --text:#e0ffe7; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{ background:var(--bg); color:var(--text); font-family:'Tajawal',sans-serif; margin:0; padding:0; min-height:100vh; display:flex; flex-direction:column; }
    .header{ text-align:center; padding:28px 16px; background:linear-gradient(to bottom,var(--card),transparent); border-radius:0 0 18px 18px; }
    .header h1{ font-family:'Amiri',serif; color:var(--primary); margin:0; font-size:2rem; }
    .subtitle{ color:var(--text); opacity:0.85; margin-top:6px; }
    #current-date{ color:var(--primary); margin-top:6px; font-size:0.95rem; }
    .main{ padding:18px; padding-bottom:120px; max-width:1000px; margin:0 auto; width:100%; }

    .card{ background:var(--card); border-radius:14px; padding:16px; margin-bottom:14px; border:1px solid var(--soft); box-shadow:0 8px 24px rgba(0,0,0,0.35); }
    .card-title{ font-weight:800; color:var(--primary); display:flex; gap:10px; align-items:center; margin-bottom:10px; }

    .dhikr-counter{ background: rgba(255,255,255,0.02); padding:12px; border-radius:10px; margin:10px 0; border:1px solid rgba(255,255,255,0.03); }
    .dhikr-text{ font-family:'Amiri',serif; font-size:1.05rem; text-align:center; line-height:1.6; color:var(--text); }
    .dhikr-reference{ color:var(--primary); text-align:center; margin-top:8px; font-size:0.9rem; }
    .dhikr-benefit{ background: rgba(52,152,219,0.06); padding:8px; border-radius:8px; margin-top:8px; font-size:0.9rem; color:var(--text); border-right:3px solid var(--accent); }

    .counter-controls{ display:flex; gap:12px; justify-content:center; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .counter-btn{ background:var(--primary); color:#000; border:none; width:44px; height:44px; border-radius:50%; font-size:1.1rem; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .counter-btn:disabled{ opacity:0.45; cursor:not-allowed; }
    .complete-btn{ background:var(--secondary,#2ecc71); color:#000; border:none; padding:8px 18px; border-radius:20px; cursor:pointer; font-weight:700; }

    .progress-bar{ height:8px; background: rgba(255,255,255,0.03); border-radius:6px; overflow:hidden; margin-top:10px; }
    .progress-fill{ height:100%; background: linear-gradient(90deg,var(--primary-dark),var(--primary)); width:0%; transition:width 0.4s ease; }

    .stats-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:10px; }
    .stat-card{ padding:12px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); text-align:center; }
    .stat-number{ font-size:1.4rem; font-weight:800; color:var(--primary); }
    .stat-label{ font-size:0.85rem; opacity:0.85; }

    .bottom-nav{ position:fixed; left:0; right:0; bottom:0; height:72px; background:var(--card); display:flex; justify-content:space-around; align-items:center; border-top:1px solid var(--soft); z-index:1000; gap:6px; padding:8px 10px; }
    .nav-item{ display:flex; flex-direction:column; align-items:center; gap:6px; color:#9aa2a6; background:transparent; border:0; font-size:0.78rem; cursor:pointer; padding:6px 8px; border-radius:8px; }
    .nav-item[aria-current="true"]{ color:var(--primary); }
    .nav-item:focus{ outline:2px solid rgba(255,255,255,0.08); border-radius:6px; }

    .load-more{ display:block; margin:12px auto 6px auto; padding:8px 16px; background:var(--accent); color:#000; border-radius:10px; border:none; cursor:pointer; font-weight:700; }

    .search-box{ display:flex; gap:8px; align-items:center; background:var(--card); padding:10px; border-radius:12px; border:1px solid var(--soft); margin-bottom:12px; }
    .search-box input{ background:transparent; border:0; color:var(--text); width:100%; font-size:1rem; outline:none; }

    #toast-container{ position:fixed; left:20px; bottom:100px; z-index:2000; display:flex; flex-direction:column; gap:8px; }
    .toast{ min-width:220px; max-width:360px; background:rgba(30,30,30,0.95); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.6); display:flex; gap:10px; align-items:center; }
    .toast.success{ background:linear-gradient(90deg,#2ecc71,#27ae60); color:#000; }
    .toast.info{ background:linear-gradient(90deg,#3498db,#2e86de); color:#000; }
    .empty{ text-align:center; padding:26px 12px; color:var(--text); opacity:0.8; }
    .empty i{ font-size:3rem; color:var(--primary); opacity:0.45; margin-bottom:8px; }

    @media(min-width:900px){ .stats-grid{ grid-template-columns:repeat(4,1fr); } }
  </style>
</head>
<body id="app-body" aria-live="polite">

  <header class="header" role="banner">
    <h1>زاد الذاكرين</h1>
    <div class="subtitle">أذكار منوعة مع تتبع وتحميل تدريجي</div>
    <div id="current-date" aria-hidden="false"></div>
  </header>

  <main class="main" id="main" role="main">
    <div class="card" id="search-card" style="display:flex;flex-direction:column;">
      <div class="search-box">
        <i class="fas fa-search" style="color:var(--primary)"></i>
        <input id="searchInput" placeholder="ابحث في الأذكار (نص، مرجع، فائدة...)" oninput="handleSearch()" />
        <button class="btn" onclick="clearSearch()" title="مسح البحث" style="background:transparent;border:0;color:var(--primary);cursor:pointer"><i class="fas fa-times"></i></button>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
        <button class="btn-primary" style="max-width:220px;" onclick="loadTab('home')"><i class="fas fa-home"></i> الرئيسية</button>
        <button class="btn-primary" style="max-width:220px; background:linear-gradient(90deg,var(--accent),#9b59b6)" onclick="loadTab('morning')"><i class="fas fa-sun"></i> أذكار الصباح</button>
      </div>
    </div>

    <div id="page-content"></div>
  </main>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <nav class="bottom-nav" role="navigation" aria-label="قائمة التنقل">
    <button class="nav-item" aria-label="الرئيسية" data-tab="home" onclick="loadTab('home')">
      <i class="fas fa-home" aria-hidden="true"></i><span>الرئيسية</span>
    </button>
    <button class="nav-item" aria-label="أذكار الصباح" data-tab="morning" onclick="loadTab('morning')">
      <i class="fas fa-sun" aria-hidden="true"></i><span>أذكار الصباح</span>
    </button>
    <button class="nav-item" aria-label="أذكار المساء" data-tab="evening" onclick="loadTab('evening')">
      <i class="fas fa-moon" aria-hidden="true"></i><span>أذكار المساء</span>
    </button>
    <button class="nav-item" aria-label="أذكار متنوعة" data-tab="general" onclick="loadTab('general')">
      <i class="fas fa-star" aria-hidden="true"></i><span>أذكار متنوعة</span>
    </button>
    <button class="nav-item" aria-label="الإعدادات" data-tab="settings" onclick="loadTab('settings')">
      <i class="fas fa-cog" aria-hidden="true"></i><span>الإعدادات</span>
    </button>
  </nav>

  <script>
    /* ======== Storage & Utils ======== */
    const Storage = {
      save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){console.warn('save failed',e);} },
      load(k){ try{ const d = localStorage.getItem(k); return d?JSON.parse(d):null;}catch(e){return null;} },
      clear(k){ localStorage.removeItem(k); }
    };

    function pad(n){ return String(n).padStart(2,'0'); }
    function getCurrentDateString(){ const now = new Date(); return `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`; }
    function getArabicDate(){ const now = new Date(); return now.toLocaleDateString('ar-SA', { weekday:'long', year:'numeric', month:'long', day:'numeric' }); }

    /* ======== Toast (بديل alert) ======== */
    function showToast(msg, type='info', duration=3200){
      const c = document.getElementById('toast-container'); if(!c) return;
      const t = document.createElement('div'); t.className='toast '+(type||'info'); t.textContent = msg;
      t.addEventListener('click', ()=>t.remove());
      c.appendChild(t); setTimeout(()=>t.remove(), duration);
    }

    /* ======== App State ======== */
    let AppState = {
      currentTab: 'home',
      currentTheme: Storage.load('app_theme') || 'default',
      adhkarHistory: Storage.load('adhkar_history') || {}, // id -> { current, completed }
      lastResetDate: Storage.load('last_reset_date') || '',
      dailyStats: Storage.load('daily_stats') || { total:0, completed:0, date:'' },
      settings: Storage.load('app_settings') || { sound:true, notifications:true, autoReset:true, showBenefits:true }
    };

    /* ======== Large Data (loaded from three files) ======== */
    let LargeAdhkarList = []; // combined entries
    const CHUNK_SIZE = 20; // items per "load more"
    const loadedCounts = { morning:0, evening:0, general:0, search:0 };
    let currentSearchQuery = '';

    /* ======== Fetch split JSON files and merge ======== */
    async function loadAdhkarJson(){
      if (LargeAdhkarList.length) return LargeAdhkarList;
      try{
        const files = ['morning.json','evening.json','general.json'];
        const promises = files.map(f => fetch(f).then(r => { if(!r.ok) throw new Error('فشل تحميل '+f); return r.json(); }));
        const results = await Promise.all(promises);
        // each file structure: { entries: [ ... ] }
        LargeAdhkarList = [];
        results.forEach((res, idx) => {
          const entries = (res && res.entries) ? res.entries : [];
          // ensure category field exists; keep as-is
          LargeAdhkarList = LargeAdhkarList.concat(entries);
        });
        return LargeAdhkarList;
      } catch(e){
        console.error(e);
        showToast("تعذّر تحميل ملفات الأذكار. تأكد من وجود morning.json, evening.json, general.json", "warn", 6000);
        return [];
      }
    }

    /* ======== Helper: get entries by category & optional search ======== */
    function getEntriesByCategory(cat){
      const all = LargeAdhkarList;
      const q = currentSearchQuery.trim().toLowerCase();
      let list = all.filter(e => e.category === cat);
      if(q){
        list = list.filter(e => (e.text + ' ' + (e.reference||'') + ' ' + (e.benefit||'')).toLowerCase().includes(q));
      }
      return list;
    }

    /* ======== Update daily stats (fixed) ======== */
    function updateDailyStats(){
      const all = LargeAdhkarList.length ? LargeAdhkarList : [];
      let total = 0, completed = 0;
      all.forEach(d => {
        total += (d.count || 0);
        const st = AppState.adhkarHistory[d.id];
        if(st) completed += (st.current || 0);
      });
      AppState.dailyStats = { total, completed, date: getCurrentDateString() };
      Storage.save('daily_stats', AppState.dailyStats);
    }

    /* ======== Daily reset ======== */
    function checkDailyReset(){
      if(!AppState.settings.autoReset) return;
      const today = getCurrentDateString();
      if(AppState.lastResetDate !== today){
        Object.keys(AppState.adhkarHistory).forEach(id => {
          AppState.adhkarHistory[id].current = 0; AppState.adhkarHistory[id].completed = false;
        });
        AppState.dailyStats = { total:0, completed:0, date:today };
        AppState.lastResetDate = today;
        Storage.save('adhkar_history', AppState.adhkarHistory);
        Storage.save('daily_stats', AppState.dailyStats);
        Storage.save('last_reset_date', today);
        if(AppState.settings.notifications) showToast("تم إعادة تعيين أذكار اليوم", "info");
      }
    }

    /* ======== Update single dhikr count (partial DOM update) ======== */
    function updateDhikrCount(id, change){
      const dh = LargeAdhkarList.find(x => x.id === id);
      if(!dh) return;
      const current = AppState.adhkarHistory[id] || { current:0, completed:false };
      let newCount = current.current + change;
      if(newCount < 0) newCount = 0;
      if(newCount > dh.count) newCount = dh.count;
      AppState.adhkarHistory[id] = { current: newCount, completed: newCount >= dh.count };
      Storage.save('adhkar_history', AppState.adhkarHistory);
      updateDailyStats();

      const el = document.getElementById(`adhkar-${id}`);
      if(el){
        const display = el.querySelector('.counter-display');
        if(display) display.textContent = `${AppState.adhkarHistory[id].current}/${dh.count}`;
        const fill = el.querySelector('.progress-fill');
        if(fill){
          const percent = dh.count ? Math.round((AppState.adhkarHistory[id].current / dh.count) * 100) : 0;
          fill.style.width = percent + '%';
        }
        const minus = el.querySelector('.btn-minus');
        const plus = el.querySelector('.btn-plus');
        const completeBtn = el.querySelector('.btn-complete');
        const disabled = AppState.adhkarHistory[id].completed;
        if(minus) minus.disabled = disabled;
        if(plus) plus.disabled = disabled;
        if(completeBtn){ completeBtn.disabled = disabled; completeBtn.textContent = disabled ? 'مكتمل ✓' : 'إكمال'; }
      }
      if(AppState.currentTab === 'home') renderHome();
    }

    function completeDhikr(id){
      const dh = LargeAdhkarList.find(x => x.id === id);
      if(!dh) return;
      AppState.adhkarHistory[id] = { current: dh.count, completed: true };
      Storage.save('adhkar_history', AppState.adhkarHistory);
      updateDailyStats();
      const el = document.getElementById(`adhkar-${id}`);
      if(el){
        el.querySelector('.counter-display').textContent = `${dh.count}/${dh.count}`;
        el.querySelector('.progress-fill').style.width = '100%';
        const minus = el.querySelector('.btn-minus');
        const plus = el.querySelector('.btn-plus');
        const completeBtn = el.querySelector('.btn-complete');
        if(minus) minus.disabled = true;
        if(plus) plus.disabled = true;
        if(completeBtn){ completeBtn.disabled = true; completeBtn.textContent = 'مكتمل ✓'; }
      } else {
        reloadCurrentTab();
      }
      if(AppState.settings.notifications) showToast("تم إكمال الذكر. جزاك الله خيراً", "success");
    }

    /* ======== Render functions with lazy append ======== */
    async function renderHome(){
      const content = document.getElementById('page-content');
      content.className = 'card fade-in';
      await loadAdhkarJson();
      updateDailyStats();
      const pct = AppState.dailyStats.total ? Math.round((AppState.dailyStats.completed / AppState.dailyStats.total) * 100) : 0;

      let html = `
        <div class="card-title"><i class="fas fa-chart-line"></i> إحصائيات اليوم</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number">${AppState.dailyStats.completed}</div><div class="stat-label">ذِكْر مُنجَز</div></div>
          <div class="stat-card"><div class="stat-number">${AppState.dailyStats.total}</div><div class="stat-label">المطلوب اليوم</div></div>
          <div class="stat-card"><div class="stat-number">${pct}%</div><div class="stat-label">نسبة الإنجاز</div></div>
          <div class="stat-card"><div class="stat-number">${Object.values(AppState.adhkarHistory).filter(d=>d && d.completed).length}</div><div class="stat-label">أذكار مكتملة</div></div>
        </div>
        <div class="progress-bar" style="margin-top:10px;"><div class="progress-fill" style="width:${pct}%;"></div></div>
      `;

      // recommendation
      const hour = new Date().getHours();
      let rec = 'general', label='أذكار متنوعة';
      if(hour >=4 && hour < 12){ rec='morning'; label='أذكار الصباح'; }
      else if(hour >=17 && hour < 24){ rec='evening'; label='أذكار المساء'; }

      const sample = getEntriesByCategory(rec).slice(0,3);
      html += `<div class="card-title" style="margin-top:12px;"><i class="fas fa-clock"></i> مقترح الآن — ${label}</div>`;
      if(sample.length){
        sample.forEach(d=>{
          const st = AppState.adhkarHistory[d.id] || { current:0, completed:false };
          html += `<div class="dhikr-counter">
                    <div class="dhikr-text">${d.text}</div>
                    <div class="dhikr-reference">${d.reference || ''}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                      <div class="counter-display">${st.current}/${d.count}</div>
                      <button class="btn-primary" onclick="loadTab('${rec}')">الذهاب إلى ${label}</button>
                    </div>
                  </div>`;
        });
      } else {
        html += `<div class="empty"><i class="fas fa-star"></i><p>لا توجد اقتراحات الآن</p></div>`;
      }

      // recent completions
      const recent = LargeAdhkarList.filter(d => AppState.adhkarHistory[d.id] && AppState.adhkarHistory[d.id].completed).slice(0,4);
      html += `<div class="card-title" style="margin-top:12px;"><i class="fas fa-trophy"></i> إنجازات اليوم</div>`;
      if(recent.length){
        recent.forEach(d => {
          html += `<div style="background:rgba(46,204,113,0.06);padding:10px;border-radius:8px;margin:8px 0;text-align:center;">
                    <i class="fas fa-check-circle" style="color:var(--secondary,#2ecc71)"></i>
                    <div style="margin-top:8px;">${d.text}</div>
                  </div>`;
        });
      } else {
        html += `<div class="empty"><i class="fas fa-star"></i><p>لم تكمل أي ذكر اليوم. ابدأ الآن!</p></div>`;
      }

      content.innerHTML = html;
    }

    async function renderCategory(category, title, icon){
      const content = document.getElementById('page-content');
      content.className = 'fade-in';
      await loadAdhkarJson();

      if(loadedCounts[category] === undefined) loadedCounts[category] = 0;
      if(currentSearchQuery) loadedCounts.search = 0;

      const list = getEntriesByCategory(category);
      const totalAvailable = list.length;
      const start = (currentSearchQuery ? loadedCounts.search : loadedCounts[category]) || 0;
      const slice = list.slice(start, start + CHUNK_SIZE);

      if(start === 0){
        let headerHtml = `<div class="card"><div class="card-title"><i class="${icon}"></i> ${title}</div>`;
        headerHtml += `<div id="dhikr-list"></div>`;
        headerHtml += `</div><div style="text-align:center;"><button id="loadMoreBtn" class="load-more">تحميل المزيد</button></div>`;
        content.innerHTML = headerHtml;
      }

      const container = document.getElementById('dhikr-list');
      slice.forEach(item => {
        const st = AppState.adhkarHistory[item.id] || { current:0, completed:false };
        const percent = item.count ? Math.round((st.current / item.count) * 100) : 0;
        const node = document.createElement('div');
        node.className = 'dhikr-counter';
        node.id = `adhkar-${item.id}`;
        node.innerHTML = `
          <div class="dhikr-text">${item.text}</div>
          <div class="dhikr-reference">${item.reference || ''}</div>
          ${AppState.settings.showBenefits && item.benefit ? `<div class="dhikr-benefit"><i class="fas fa-heart"></i> ${item.benefit}</div>` : ''}
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
            <div style="color:var(--primary);font-weight:700;">التكرار المطلوب: ${item.count}</div>
            <div class="counter-display">${st.current}/${item.count}</div>
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${percent}%;"></div></div>
          <div class="counter-controls">
            <button class="counter-btn btn-minus" onclick="updateDhikrCount(${item.id}, -1)" ${st.completed ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
            <button class="complete-btn btn-complete" onclick="completeDhikr(${item.id})" ${st.completed ? 'disabled' : ''}>${st.completed ? 'مكتمل ✓' : 'إكمال'}</button>
            <button class="counter-btn btn-plus" onclick="updateDhikrCount(${item.id}, 1)" ${st.completed ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
          </div>
        `;
        container.appendChild(node);
      });

      if(currentSearchQuery) loadedCounts.search = start + slice.length;
      else loadedCounts[category] = start + slice.length;

      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if(loadMoreBtn){
        const nextStart = currentSearchQuery ? loadedCounts.search : loadedCounts[category];
        if(nextStart >= totalAvailable) loadMoreBtn.style.display = 'none';
        else {
          loadMoreBtn.style.display = 'inline-block';
          loadMoreBtn.onclick = () => renderCategory(category, title, icon);
        }
      }
    }

    function renderMorning(){ return renderCategory('morning','أذكار الصباح','fas fa-sun'); }
    function renderEvening(){ return renderCategory('evening','أذكار المساء','fas fa-moon'); }
    function renderGeneral(){ return renderCategory('general','أذكار متنوعة','fas fa-star'); }

    /* ======== Search handling ======== */
    function handleSearch(){
      const q = document.getElementById('searchInput').value || '';
      currentSearchQuery = q;
      loadedCounts.search = 0;
      // show results in general category view but filtered
      renderCategory('general','نتائج البحث','fas fa-search');
    }
    function clearSearch(){ document.getElementById('searchInput').value=''; currentSearchQuery=''; loadedCounts.search=0; loadTab(AppState.currentTab || 'home'); }

    /* ======== Settings, Export/Import, Reset ======== */
    function renderSettings(){
      const content = document.getElementById('page-content');
      content.className = 'fade-in';
      const theme = AppState.currentTheme;
      let html = `<div class="card"><div class="card-title"><i class="fas fa-cog"></i> إعدادات التطبيق</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <label style="display:flex;justify-content:space-between;align-items:center;">
            <div><div style="font-weight:700;">تشغيل الأصوات</div><div style="font-size:0.85rem;opacity:0.8;">تشغيل صوت عند زيادة العداد</div></div>
            <input type="checkbox" ${AppState.settings.sound ? 'checked' : ''} onchange="toggleSetting('sound')">
          </label>
          <label style="display:flex;justify-content:space-between;align-items:center;">
            <div><div style="font-weight:700;">الإشعارات</div><div style="font-size:0.85rem;opacity:0.8;">عرض رسائل التأكيد</div></div>
            <input type="checkbox" ${AppState.settings.notifications ? 'checked' : ''} onchange="toggleSetting('notifications')">
          </label>
          <label style="display:flex;justify-content:space-between;align-items:center;">
            <div><div style="font-weight:700;">إعادة تعيين تلقائي</div><div style="font-size:0.85rem;opacity:0.8;">إعادة العدادات يومياً</div></div>
            <input type="checkbox" ${AppState.settings.autoReset ? 'checked' : ''} onchange="toggleSetting('autoReset')">
          </label>
          <label style="display:flex;justify-content:space-between;align-items:center;">
            <div><div style="font-weight:700;">عرض الفضائل</div><div style="font-size:0.85rem;opacity:0.8;">عرض فوائد الأذكار</div></div>
            <input type="checkbox" ${AppState.settings.showBenefits ? 'checked' : ''} onchange="toggleSetting('showBenefits')">
          </label>
        </div>
      </div>`;

      html += `<div class="card"><div class="card-title"><i class="fas fa-database"></i> بيانات</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <button class="btn-primary" onclick="exportData()">تصدير البيانات</button>
          <button class="btn-primary" style="background:linear-gradient(90deg,var(--accent),#9b59b6)" onclick="importData()">استيراد البيانات</button>
          <button class="reset-btn" onclick="resetAllData()">حذف جميع البيانات</button>
        </div>
      </div>`;

      html += `<div class="card"><div class="card-title"><i class="fas fa-info-circle"></i> حول</div>
        <p style="line-height:1.6;">تطبيق زاد الذاكرين — تم تقسيم الأذكار إلى ملفات منفصلة (morning.json, evening.json, general.json) ويتم تحميلها تدريجياً لتحسين الأداء.</p>
      </div>`;

      content.innerHTML = html;
    }

    function toggleSetting(name){
      AppState.settings[name] = !AppState.settings[name];
      Storage.save('app_settings', AppState.settings);
      if(name === 'autoReset' && !AppState.settings.autoReset){
        AppState.lastResetDate = '';
        Storage.save('last_reset_date','');
      }
      renderSettings();
      showToast('تم تحديث الإعدادات', 'info');
    }

    function exportData(){
      const data = { adhkarHistory: AppState.adhkarHistory, settings: AppState.settings, theme: AppState.currentTheme, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'زاد-الذاكرين-البيانات.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showToast('تم تصدير البيانات', 'success');
    }

    function importData(){
      const input = document.createElement('input'); input.type = 'file'; input.accept = '.json,application/json';
      input.onchange = e => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ev => {
          try{
            const data = JSON.parse(ev.target.result);
            if(!confirm('هل تريد استيراد البيانات؟ سيتم استبدال بياناتك الحالية.')) return;
            if(data.adhkarHistory){ AppState.adhkarHistory = data.adhkarHistory; Storage.save('adhkar_history', AppState.adhkarHistory); }
            if(data.settings){ AppState.settings = data.settings; Storage.save('app_settings', AppState.settings); }
            if(data.theme){ AppState.currentTheme = data.theme; applyTheme(data.theme); }
            updateDailyStats();
            showToast('تم استيراد البيانات', 'success');
            loadTab('home');
          }catch(err){ console.error(err); showToast('ملف غير صالح للاستيراد', 'warn'); }
        };
        r.readAsText(f);
      };
      input.click();
    }

    function resetAllData(){
      if(!confirm('هل أنت متأكد من حذف جميع البيانات؟')) return;
      localStorage.clear();
      AppState = {
        currentTab:'home', currentTheme:'default', adhkarHistory:{}, lastResetDate:'', dailyStats:{total:0,completed:0,date:''},
        settings:{ sound:true, notifications:true, autoReset:true, showBenefits:true }
      };
      applyTheme('default');
      renderHome();
      showToast('تم حذف جميع البيانات', 'info');
      setTimeout(()=>location.reload(), 600);
    }

    /* ======== Theme apply ======== */
    const Themes = [{id:'default',name:'ذهبي',class:''},{id:'blue',name:'أزرق',class:'theme-blue'},{id:'green',name:'أخضر',class:'theme-green'},{id:'purple',name:'أرجواني',class:'theme-purple'},{id:'orange',name:'برتقالي',class:'theme-orange'}];
    function applyTheme(themeId=AppState.currentTheme){
      const body = document.getElementById('app-body');
      Themes.forEach(t => { if(t.class) body.classList.remove(t.class); });
      const sel = Themes.find(t => t.id === themeId);
      if(sel && sel.class) body.classList.add(sel.class);
      AppState.currentTheme = themeId; Storage.save('app_theme', themeId);
    }

    /* ======== Tab loader ======== */
    async function loadTab(tabName){
      AppState.currentTab = tabName;
      document.querySelectorAll('.nav-item').forEach(btn => btn.setAttribute('aria-current', btn.getAttribute('data-tab') === tabName ? 'true' : 'false'));
      currentSearchQuery = '';
      document.getElementById('searchInput').value = '';
      if(!loadedCounts[tabName]) loadedCounts[tabName] = 0;
      if(tabName === 'home') await renderHome();
      else if(tabName === 'morning') await renderMorning();
      else if(tabName === 'evening') await renderEvening();
      else if(tabName === 'general') await renderGeneral();
      else if(tabName === 'settings') renderSettings();
      window.scrollTo({ top:0, behavior:'smooth' });
    }

    function reloadCurrentTab(){ loadTab(AppState.currentTab || 'home'); }

    /* ======== Initialization ======== */
    window.addEventListener('load', async () => {
      applyTheme();
      document.getElementById('current-date').textContent = getArabicDate();
      setInterval(()=>{ document.getElementById('current-date').textContent = getArabicDate(); }, 60000);
      await loadAdhkarJson();
      checkDailyReset();
      setInterval(checkDailyReset, 3600000);
      updateDailyStats();
      loadTab('home');
    });

    // expose functions to global for inline onclick handlers
    window.loadTab = loadTab;
    window.renderMorning = renderMorning;
    window.renderEvening = renderEvening;
    window.renderGeneral = renderGeneral;
    window.updateDhikrCount = updateDhikrCount;
    window.completeDhikr = completeDhikr;
    window.changeTheme = applyTheme;
    window.toggleSetting = toggleSetting;
    window.exportData = exportData;
    window.importData = importData;
    window.resetAllData = resetAllData;
    window.handleSearch = handleSearch;
    window.clearSearch = clearSearch;
  </script>
</body>
</html>